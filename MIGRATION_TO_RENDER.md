# Migration Guide: Fly.io â†’ Render + PostgreSQL

This guide walks you through migrating the ChatLab backend from Fly.io (SQLite) to Render (PostgreSQL).

## Overview

**Benefits of this migration:**
- Simpler deployment process (no Docker configuration needed)
- Better free tier with more generous limits
- Integrated PostgreSQL database with better performance
- Auto-deployment from GitHub
- Better monitoring and logging capabilities

## Prerequisites

- Existing ChatLab project with data in Fly.io/SQLite
- GitHub account (for auto-deployment)
- Render account (free tier available)

## Migration Steps

### Phase 1: Data Export

1. **Export existing SQLite data:**
   ```bash
   cd backend
   python export_sqlite_data.py
   ```
   
   This creates a `migration_data/` directory with JSON files containing all your data.

2. **Verify export:**
   ```bash
   ls migration_data/
   # Should show: users.json, characters.json, conversations.json, messages.json, export_summary.json
   ```

### Phase 2: Render Setup

3. **Create Render account and connect GitHub:**
   - Sign up at [render.com](https://render.com)
   - Connect your GitHub account
   - Fork or push your ChatLab repository to GitHub

4. **Deploy using render.yaml:**
   - Ensure `render.yaml` is in your repository root
   - In Render dashboard, create a new "Blueprint"
   - Connect to your GitHub repository
   - Render will automatically detect the `render.yaml` and create services

5. **Set environment variables in Render:**
   - Go to your web service settings
   - Add the following environment variables:
     ```
     OPENAI_API_KEY=your_openai_key
     ANTHROPIC_API_KEY=your_anthropic_key
     SUPABASE_URL=your_supabase_url
     SUPABASE_KEY=your_supabase_key
     AI_PROVIDER=anthropic
     CORS_ORIGINS=["http://localhost:5173", "https://your-frontend-domain.vercel.app"]
     ```

### Phase 3: Data Migration

6. **Wait for initial deployment:**
   - Let Render complete the initial deployment
   - The PostgreSQL database will be created automatically
   - The backend service will start (may fail initially due to empty database)

7. **Import data to PostgreSQL:**
   ```bash
   # Set the DATABASE_URL environment variable to your Render PostgreSQL URL
   export DATABASE_URL="postgresql://user:password@host:port/database"
   
   # Run the import script
   cd backend
   python import_postgresql_data.py
   ```

   **Note:** Get the DATABASE_URL from your Render PostgreSQL service dashboard.

### Phase 4: Frontend Configuration

8. **Update frontend for Render:**
   - Frontend `.env.production` is already updated to point to Render
   - If deploying frontend to Vercel, no additional changes needed
   - If deploying to Render, uncomment the frontend section in `render.yaml`

9. **Deploy frontend:**
   ```bash
   cd frontend
   npm run build
   # Deploy to Vercel or enable frontend in render.yaml
   ```

### Phase 5: Testing & Verification

10. **Test the migration:**
    - Visit your new Render backend URL
    - Check `/health` endpoint: `https://your-app.onrender.com/health`
    - Test API endpoints with frontend
    - Verify all data was migrated correctly

11. **Update DNS/URLs:**
    - Update any hardcoded URLs to point to Render
    - Update frontend environment variables if needed
    - Test authentication and all features

## Environment Variables

### Backend (Render Web Service)
```
ENVIRONMENT=production
DATABASE_URL=[auto-generated by Render PostgreSQL]
OPENAI_API_KEY=your_key
ANTHROPIC_API_KEY=your_key
SUPABASE_URL=your_url
SUPABASE_KEY=your_key
AI_PROVIDER=anthropic
CORS_ORIGINS=["https://your-frontend.vercel.app"]
```

### Frontend (Production)
```
VITE_API_BASE_URL=https://chatlab-backend.onrender.com
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_key
```

## Troubleshooting

### Common Issues

**1. Database Connection Errors:**
- Verify DATABASE_URL is correctly set
- Check PostgreSQL service is running in Render
- Ensure firewall allows connections

**2. CORS Errors:**
- Add your frontend domain to CORS_ORIGINS
- Use the exact domain (with https://)
- Check environment variable format

**3. Import Script Failures:**
- Ensure all JSON files exist in migration_data/
- Check PostgreSQL connection string
- Verify table schemas match

**4. Missing Environment Variables:**
- Double-check all required variables are set in Render
- Use Render's environment variable interface (not secrets)
- Restart the service after adding variables

### Verification Commands

```bash
# Check database connection
python -c "
from app.config import settings
from app.database import engine
print(f'Database URL: {settings.get_database_url()}')
print(f'Is PostgreSQL: {settings.is_postgresql}')
with engine.connect() as conn:
    print('âœ… Database connection successful')
"

# Check data migration
python -c "
from app.database import SessionLocal
from app.models import User, Character, Conversation, Message
session = SessionLocal()
print(f'Users: {session.query(User).count()}')
print(f'Characters: {session.query(Character).count()}')
print(f'Conversations: {session.query(Conversation).count()}')
print(f'Messages: {session.query(Message).count()}')
session.close()
"
```

## Rollback Plan

If you need to rollback to Fly.io:

1. **Keep Fly.io deployment active** during migration testing
2. **Backup data** before starting migration
3. **DNS rollback:** Change frontend API URL back to Fly.io
4. **Database rollback:** Keep SQLite database files

## Performance Considerations

**PostgreSQL vs SQLite:**
- Better concurrent access handling
- Improved query performance for complex operations
- Native JSON support for better data handling
- Proper transaction isolation

**Render vs Fly.io:**
- Different regions available (choose closest to users)
- Free tier limitations (750 hours/month)
- Auto-sleep after 15 minutes of inactivity (free tier)

## Post-Migration Tasks

1. **Monitor performance** for the first week
2. **Update documentation** with new URLs
3. **Remove Fly.io deployment** after successful migration
4. **Set up monitoring** and alerts in Render
5. **Configure backups** for PostgreSQL database

## Support

If you encounter issues:

1. Check Render service logs for error details
2. Verify all environment variables are set correctly
3. Test database connection independently
4. Compare working local setup with production

## Cost Comparison

**Fly.io:**
- Free tier: Limited resources
- Paid: $1.94/month minimum

**Render:**
- Free tier: 750 hours/month, auto-sleep
- Paid: $7/month for always-on service

**Database:**
- Fly.io: SQLite (file-based, included)
- Render: PostgreSQL (managed, free tier available)

---

**Migration completed successfully!** ðŸŽ‰

Your ChatLab application is now running on Render with PostgreSQL, providing better scalability and easier maintenance.